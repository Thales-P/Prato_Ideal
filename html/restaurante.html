<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carregando Restaurante...</title> 
  <link rel="stylesheet" href="css/style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    body { background-color: #f8f9fa; }
    #restaurante-header { min-height: 40vh; background-size: cover; background-position: center; position: relative; color: white; display: flex; align-items: flex-end; padding: 2rem; border-radius: 0 0 15px 15px; }
    #restaurante-header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to top, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.5) 50%, transparent 100%); border-radius: 0 0 15px 15px; }
    #restaurante-header * { position: relative; z-index: 2; }
    .rating-details { font-size: 1.2rem; color: #ffc107; }
    .review-card { border: 1px solid #e9ecef; }
    .review-user-avatar { width: 50px; height: 50px; object-fit: cover; }
    .review-photos img { width: 90px; height: 90px; object-fit: cover; border-radius: 8px; margin-right: 10px; cursor: pointer; }
    .rating-stars { font-size: 2rem; color: #ccc; cursor: pointer; }
    .rating-stars .fas.fa-star { color: #ffc107; }
    #user-avatar { width: 40px; height: 40px; object-fit: cover; }
    #img-logo-nav { width: 50px; height: 50px; margin-right: 10px; }
  </style>
</head>
<body>
  <nav id="nav-top" class="navbar navbar-expand-md bg-light shadow-sm">
      <div class="container">
        <img id="img-logo-nav" src="../imagens/logo-preto.svg" alt="Logo" />
          <a class="navbar-brand fs-2 fw-bolder" href="../index.html">Prato Ideal</a>
          <div class="ms-auto">
            <div id="nav-user-section" class="d-flex align-items-center">
                </div>
          </div>
      </div>
  </nav>

  <header id="restaurante-header">
    <div class="container">
        <h1 id="rest-nome" class="display-4 fw-bold">Carregando...</h1>
        <p id="rest-categoria" class="lead fs-4"></p>
    </div>
  </header>

  <div class="container mt-4">
    <div class="row gx-4">
      <div class="col-lg-8">
        <div class="bg-white p-4 rounded shadow-sm mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <h2>Avaliações</h2>
                <button id="btn-abrir-modal-avaliacao" class="btn btn-primary">
                  <i class="fas fa-star"></i> Deixe sua avaliação
                </button>
            </div>
            <hr>
            <div id="lista-avaliacoes" class="d-flex flex-column gap-3">
              <div id="avaliacoes-spinner" class="text-center p-4"><div class="spinner-border text-secondary" role="status"></div></div>
            </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="bg-white p-4 rounded shadow-sm">
          <h4>Informações</h4>
          <hr>
          <p><strong>Avaliação Média:</strong><br><span id="rest-avaliacao" class="rating-details"></span></p>
          <p><strong>Faixa de Preço:</strong><br><span id="rest-faixa-preco" class="fs-4"></span></p>
          <p><strong>Endereço:</strong><br><span id="rest-endereco"></span></p>
          <p><strong>Telefone:</strong><br><span id="rest-telefone"></span></p>
        </div>
      </div>
    </div>
  </div>

  <footer class="py-3 mt-5 bg-dark text-white text-center">
    <div class="container"><p class="mb-0">2025 Prato Ideal. Todos os direitos reservados.</p></div>
  </footer>

  <div class="modal fade" id="modalAvaliacao" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">Avaliar: <span id="restaurant-name-in-modal"></span></h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="reviewForm" novalidate><input type="hidden" id="idRestauranteInput"><input type="hidden" id="idUsuarioInput"><div class="mb-3"><label class="form-label">Sua Nota:</label><div id="starRating" class="rating-stars"><i class="far fa-star" data-value="1"></i><i class="far fa-star" data-value="2"></i><i class="far fa-star" data-value="3"></i><i class="far fa-star" data-value="4"></i><i class="far fa-star" data-value="5"></i></div><input type="hidden" id="notaInput" required><div class="invalid-feedback d-none" id="notaError">Por favor, dê uma nota.</div></div><div class="mb-3"><label for="comentario" class="form-label">Seu Comentário:</label><textarea class="form-control" id="comentario" rows="5" placeholder="Conte-nos sobre sua experiência..." required></textarea><div class="invalid-feedback">Por favor, escreva um comentário.</div></div></form></div><div class="modal-footer"><div id="form-message" class="text-center me-auto"></div><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-success" form="reviewForm"><i class="fas fa-paper-plane"></i> Enviar Avaliação</button></div></div></div>
  </div>

  <div class="modal fade" id="modalLoginNecessario" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Acesso Necessário</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Você precisa estar logado para deixar uma avaliação.</p><p>Faça o login ou crie sua conta gratuitamente.</p></div><div class="modal-footer"><a href="cadastro.html" class="btn btn-secondary">Criar Conta</a><a href="login.html" class="btn btn-primary">Fazer Login</a></div></div></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script defer>
    document.addEventListener('DOMContentLoaded', () => {
      // --- URLs, Elementos e Variáveis Globais ---
      const RESTAURANTE_API_URL = 'https://apirestaurantes.onrender.com/api/Restaurante';
      const REVIEW_API_URL = 'https://apirestaurantes.onrender.com/api/Review';
      const USUARIO_API_URL = 'https://apirestaurantes.onrender.com/api/Usuario';
      let restauranteAtual = null;

      // --- LÓGICA DE LOGIN E NAVBAR (VERSÃO TOKEN JWT) ---
      function parseJwt(token) {
        try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; }
      }

      function getUsuarioLogado() {
        const token = localStorage.getItem('token');
        if (!token) return null;
        const decoded = parseJwt(token);
        if (decoded && decoded.exp * 1000 > Date.now()) {
          return { Id: decoded.nameid, Nome: decoded.unique_name, Foto: `https://i.pravatar.cc/150?u=${decoded.nameid}` };
        }
        localStorage.removeItem('token');
        return null;
      }

      function handleLogout() {
        localStorage.removeItem('token');
        window.location.reload();
      }

      function configurarNavbar() {
        const userSection = document.getElementById('nav-user-section');
        const usuario = getUsuarioLogado();
        if (usuario && usuario.Nome) {
          userSection.innerHTML = `<span class="navbar-text me-3">Olá, <strong>${usuario.Nome.split(' ')[0]}</strong></span><img src="${usuario.Foto}" alt="Avatar" id="user-avatar" class="rounded-circle"><button id="btn-logout" class="btn btn-link text-secondary ms-2 text-decoration-none">Sair</button>`;
          document.getElementById('btn-logout').addEventListener('click', handleLogout);
        } else {
          userSection.innerHTML = '<a href="login.html" class="btn btn-primary fw-bold">ENTRAR</a>';
        }
      }

      // --- LÓGICA PRINCIPAL DA PÁGINA ---
      async function carregarPagina() {
        configurarNavbar();

        const params = new URLSearchParams(window.location.search);
        const restauranteId = params.get('id');
        
        if (!restauranteId) {
          document.body.innerHTML = '<div class="alert alert-danger text-center m-5"><h1>Erro: ID do restaurante não fornecido.</h1><a href="index.html">Voltar</a></div>';
          return;
        }
        
        try {
          const [restaurante, reviews] = await Promise.all([
              fetch(`${RESTAURANTE_API_URL}/${restauranteId}`).then(res => res.json()),
              fetch(`${REVIEW_API_URL}/restaurante/${restauranteId}`).then(res => res.json())
          ]);
          
          restauranteAtual = restaurante; 
          preencherInfoRestaurante(restaurante);

          if (reviews && reviews.length > 0) {
              const usuariosMap = await buscarDadosDeUsuarios(reviews);
              renderizarAvaliacoes(reviews, usuariosMap);
          } else {
              document.getElementById('lista-avaliacoes').innerHTML = '<p class="text-muted">Este restaurante ainda não possui avaliações.</p>';
          }
        } catch (error) {
          console.error("Erro ao carregar a página de detalhes:", error);
          document.body.innerHTML = `<div class="alert alert-danger text-center m-5"><h1>Oops! Não foi possível carregar os detalhes.</h1><p>${error.message}</p><a href="index.html">Voltar</a></div>`;
        }
      }

      // --- LÓGICA DO MODAL E FORMULÁRIO ---
      const modalAvaliacaoEl = document.getElementById('modalAvaliacao');
      const btnAbrirModalAvaliacao = document.getElementById('btn-abrir-modal-avaliacao');
      
      if (modalAvaliacaoEl && btnAbrirModalAvaliacao) {
        const modalAvaliacao = new bootstrap.Modal(modalAvaliacaoEl);
        const modalLogin = new bootstrap.Modal(document.getElementById('modalLoginNecessario'));

        btnAbrirModalAvaliacao.addEventListener('click', () => {
          if (getUsuarioLogado()) {
            modalAvaliacao.show();
          } else {
            modalLogin.show();
          }
        });
        
        modalAvaliacaoEl.addEventListener('show.bs.modal', function () {
            if (restauranteAtual) {
                document.getElementById('restaurant-name-in-modal').textContent = restauranteAtual.Nome;
                document.getElementById('idRestauranteInput').value = restauranteAtual.Id;
                const form = document.getElementById('reviewForm');
                form.reset();
                form.querySelector('#notaInput').value = '';
                form.querySelector('#form-message').textContent = '';
                highlightStarsVisual(0);
            }
        });

        const reviewForm = document.getElementById('reviewForm');
        reviewForm.addEventListener('submit', async function(event) {
          event.preventDefault();
          if (!validarFormulario()) return;
          const submitButton = reviewForm.querySelector('button[type="submit"]');
          submitButton.disabled = true;
          const formMessage = document.getElementById('form-message');
          formMessage.textContent = 'Enviando...';
          formMessage.className = 'text-center me-auto text-info';
          try {
              await enviarAvaliacao();
              formMessage.textContent = 'Avaliação enviada com sucesso!';
              formMessage.className = 'text-center me-auto text-success';
              setTimeout(() => {
                  modalAvaliacao.hide();
                  location.reload(); 
              }, 1500);
          } catch (error) {
              formMessage.textContent = `Erro: ${error.message}`;
              formMessage.className = 'text-center me-auto text-danger';
              submitButton.disabled = false;
          }
        });
      }

      function highlightStarsVisual(rating) {
        document.querySelectorAll('#starRating .fa-star').forEach((s, i) => {
            s.classList.toggle('fas', i < rating);
            s.classList.toggle('far', i >= rating);
        });
      }
      document.querySelectorAll('#starRating .fa-star').forEach(star => {
          star.addEventListener('click', () => {
              document.getElementById('notaInput').value = star.dataset.value;
              highlightStarsVisual(star.dataset.value);
          });
      });
      
      // --- FUNÇÕES AUXILIARES ---
      function validarFormulario() {
        let isValid = true;
        if (!document.getElementById('notaInput').value) { isValid = false; }
        if (document.getElementById('comentario').value.trim() === '') { isValid = false; }
        return isValid;
      }

      async function enviarAvaliacao() {
        const usuarioLogado = getUsuarioLogado();
        if(!usuarioLogado) throw new Error("Usuário não logado.");
        const reviewData = {
          IdRestaurante: document.getElementById('idRestauranteInput').value,
          IdUsuario: usuarioLogado.Id,
          Nota: parseInt(document.getElementById('notaInput').value),
          Comentario: document.getElementById('comentario').value,
          Data: new Date().toISOString()
        };
        const response = await fetch(REVIEW_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(reviewData) });
        if (!response.ok) { const errorText = await response.text(); throw new Error(errorText || `Erro no servidor: ${response.status}`); }
        return await response.json();
      }

      function preencherInfoRestaurante(restaurante) {
        document.getElementById('rest-nome').textContent = restaurante.Nome;
        document.getElementById('restaurante-header').style.backgroundImage = `url(${restaurante.Foto || 'https://placehold.co/1200x400?text=Restaurante'})`;
        document.getElementById('rest-categoria').textContent = restaurante.Categoria;
        document.getElementById('rest-faixa-preco').textContent = restaurante.FaixaPreco;
        document.getElementById('rest-endereco').textContent = `${restaurante.Endereco.Rua}, ${restaurante.Endereco.Numero} - ${restaurante.Endereco.Cidade}/${restaurante.Endereco.Estado}`;
        document.getElementById('rest-telefone').textContent = `Telefone: ${restaurante.Telefone}`;
        document.getElementById('rest-avaliacao').innerHTML = restaurante.AvaliacaoMedia != null ? `${'⭐'.repeat(Math.round(restaurante.AvaliacaoMedia))} (${restaurante.AvaliacaoMedia.toFixed(1)})` : "Sem avaliações";
        document.title = `${restaurante.Nome} - Prato Ideal`;
      }

      async function buscarDadosDeUsuarios(reviews) {
        const idsDeUsuarios = [...new Set(reviews.map(review => review.IdUsuario))];
        const promessasDeUsuarios = idsDeUsuarios.map(id => fetch(`${USUARIO_API_URL}/${id}`).then(res => res.json()));
        const usuarios = await Promise.all(promessasDeUsuarios);
        const usuariosMap = new Map();
        usuarios.forEach(user => usuariosMap.set(user.Id, user));
        return usuariosMap;
      }

      function renderizarAvaliacoes(reviews, usuariosMap) {
        const listaAvaliacoesContainer = document.getElementById('lista-avaliacoes');
        listaAvaliacoesContainer.innerHTML = '';
        reviews.sort((a, b) => new Date(b.Data) - new Date(a.Data)).forEach(review => {
            const usuario = usuariosMap.get(review.IdUsuario);
            if (!usuario) return;
            const ratingHtml = '⭐'.repeat(review.Nota) + '☆'.repeat(5 - review.Nota);
            const dataFormatada = new Date(review.Data).toLocaleDateString('pt-BR');
            let fotosHtml = '';
            if (review.Fotos && review.Fotos.length > 0) {
              fotosHtml += '<div class="review-photos mt-2">';
              review.Fotos.forEach(fotoUrl => { fotosHtml += `<a href="${fotoUrl}" target="_blank"><img src="${fotoUrl}" alt="Foto da avaliação"></a>`; });
              fotosHtml += '</div>';
            }
            const reviewHtml = `<div class="review-card card mb-3"><div class="card-body"><div class="d-flex align-items-start"><img src="${usuario.Foto}" alt="Avatar de ${usuario.Nome}" class="review-user-avatar rounded-circle me-3"><div class="w-100"><div class="d-flex justify-content-between"><h6 class="mb-0 fw-bold">${usuario.Nome}</h6><small class="text-muted">${dataFormatada}</small></div><div class="rating-details mb-2">${ratingHtml}</div><p class="card-text">${review.Comentario}</p>${fotosHtml}</div></div></div></div>`;
            listaAvaliacoesContainer.innerHTML += reviewHtml;
        });
      }
      
      // INICIA A APLICAÇÃO
      carregarPagina();
    });
  </script>
</body>
</html>